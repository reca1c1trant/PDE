# Burgers2D LoRA V2 Finetuning Configuration (V3 Architecture)
# Uses PDEModelV2 with Neighborhood Attention
#
# Key features:
# - NA Transformer (not Llama)
# - LoRA applied to: qkv, proj, gate_proj, up_proj, down_proj
# - Encoder and Decoder UNFROZEN for domain adaptation

# Model (must match pretrain_v3.yaml)
model:
  pretrained_path: "./checkpoints_v3/best_tf.pt"

  # Core dimensions
  in_channels: 18          # 3 vector + 15 scalar (will use 2 for Burgers)
  hidden_dim: 768
  patch_size: 16
  num_layers: 16
  num_heads: 16
  dropout: 0.0

  # Encoder config
  encoder:
    stem_hidden: 128
    stem_out: 256
    use_cnn_pool: false

  # Intra-patch attention
  intra_patch:
    num_layers: 2
    temporal_window: 3
    num_heads: 8

  # Neighborhood Attention
  na:
    base_kernel: 5

  # Decoder config
  decoder:
    stem_channels: 256
    hidden_channels: 128

  # LoRA config (applied to NA Transformer)
  lora:
    r: 16
    alpha: 32
    dropout: 0.05
    target_modules:
      - "qkv"           # NA Attention
      - "proj"          # NA Attention
      - "gate_proj"     # SwiGLU FFN
      - "up_proj"       # SwiGLU FFN
      - "down_proj"     # SwiGLU FFN

# Dataset
dataset:
  path: "/scratch-share/SONG0304/finetune/burgers2d_nu0.1_0.15_n500.h5"
  temporal_length: 8      # t_input (model outputs t_input frames)
  train_ratio: 0.9
  seed: 42
  clips_per_sample: null

# Physics parameters
physics:
  dt: 0.001001001  # 1/999
  dx: 0.007874016  # 1/127
  dy: 0.007874016  # 1/127

# DataLoader
dataloader:
  batch_size: 8
  num_workers: 4
  pin_memory: true

# Training
training:
  max_epochs: 15
  warmup_steps: 200
  learning_rate: 1.0e-4
  min_lr: 1.0e-6
  weight_decay: 1.0e-4
  betas: [0.9, 0.999]
  grad_clip: 5.0

  # Loss weights
  lambda_pde: 0.01
  lambda_bc: 1.0

  mixed_precision: "no"
  gradient_accumulation_steps: 1
  eval_interval: 100
  early_stopping_patience: 20

# Logging
logging:
  project: "pde-burgers-lora"
  entity: "reca1c1trant-ntu"
  save_dir: "./checkpoints_burgers_lora_v2"
  log_interval: 10
